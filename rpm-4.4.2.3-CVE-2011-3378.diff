
http://rpm.org/gitweb?p=rpm.git;a=commitdiff;h=472e569562d4c90d7a298080e0052856aa7fa86b
http://rpm.org/gitweb?p=rpm.git;a=commitdiff;h=11a7e5d95a8ca8c7d4eaff179094afd8bb74fc3f
http://rpm.org/gitweb?p=rpm.git;a=commitdiff;h=a48f0e20cbe2ababc88b2fc52fb7a281d6fc1656
http://rpm.org/gitweb?p=rpm.git;a=commitdiff;h=30635dd4330a192fa2b6e202a0e2490eba599a93

diff -Naurp rpm-4.4.2.3/rpmdb/header.c rpm-4.4.2.3.oden/rpmdb/header.c
--- rpm-4.4.2.3/rpmdb/header.c	2011-10-05 09:28:16.000000000 -0400
+++ rpm-4.4.2.3.oden/rpmdb/header.c	2011-10-05 09:22:56.000000000 -0400
@@ -488,6 +488,10 @@ static int regionSwab(/*@null@*/ indexEn
 /*@-boundswrite@*/
     memset(&ieprev, 0, sizeof(ieprev));
 /*@=boundswrite@*/
+
+    if ((entry != NULL && regionid >= 0) || (entry == NULL && regionid != 0))
+	return -1;
+
     for (; il > 0; il--, pe++) {
 	struct indexEntry_s ie;
 	int_32 type;
@@ -1083,7 +1087,7 @@ Header headerLoad(/*@kept@*/ void * uh)
 
 	{   int off = ntohl(pe->offset);
 
-	    if (hdrchkData(off))
+	    if (hdrchkData(off) || hdrchkRange(dl, off))
 		goto errxit;
 	    if (off) {
 /*@-sizeoftype@*/
@@ -1148,6 +1152,11 @@ Header headerLoad(/*@kept@*/ void * uh)
 	    h->indexUsed += ne;
 	  }
 	}
+
+	rdlen += REGION_TAG_COUNT;
+	/* XXX should be equality test, but dribbles are sometimes a bit off? */
+	if (rdlen > dl || (rdlen < dl && ril == h->indexUsed))
+	    goto errxit;
     }
 
     h->flags &= ~HEADERFLAG_SORTED;
diff -Naurp rpm-4.4.2.3/rpmio/rpmpgp.c rpm-4.4.2.3.oden/rpmio/rpmpgp.c
--- rpm-4.4.2.3/rpmio/rpmpgp.c	2008-04-01 03:28:22.000000000 -0400
+++ rpm-4.4.2.3.oden/rpmio/rpmpgp.c	2011-10-05 09:27:57.000000000 -0400
@@ -301,6 +301,9 @@ int pgpPrtSubType(const byte *h, unsigne
 
     while (hlen > 0) {
 	i = pgpLen(p, &plen);
+	if (i + plen > hlen)
+	    break;
+
 	p += i;
 	hlen -= i;
 
@@ -389,7 +392,7 @@ int pgpPrtSubType(const byte *h, unsigne
 	p += plen;
 	hlen -= plen;
     }
-    return 0;
+    return (hlen != 0); /* non-zero hlen is an error */
 }
 
 /*@-varuse =readonlytrans @*/
@@ -532,7 +535,8 @@ fprintf(stderr, "   hash[%u] -- %s\n", p
 	    _digp->hashlen = sizeof(*v) + plen;
 	    _digp->hash = memcpy(xmalloc(_digp->hashlen), v, _digp->hashlen);
 	}
-	(void) pgpPrtSubType(p, plen, v->sigtype);
+	if (pgpPrtSubType(p, plen, v->sigtype))
+	    return 1;
 	p += plen;
 
 	plen = pgpGrab(p,2);
@@ -543,7 +547,8 @@ fprintf(stderr, "   hash[%u] -- %s\n", p
 
 if (_debug && _print)
 fprintf(stderr, " unhash[%u] -- %s\n", plen, pgpHexStr(p, plen));
-	(void) pgpPrtSubType(p, plen, v->sigtype);
+	if (pgpPrtSubType(p, plen, v->sigtype))
+	    return 1;
 	p += plen;
 
 	plen = pgpGrab(p,2);
